plugins {
    id 'java'
}

group = 'com.tomodrek'
version = '1.0.0'

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

ext {
    mindustryVersion = 'v155'
    arcVersion = 'v155'
}

repositories {
    mavenCentral()
    maven { url 'https://jitpack.io' }
}

dependencies {
    compileOnly "com.github.Anuken.Mindustry:core:${mindustryVersion}"
    compileOnly "com.github.Anuken.Arc:arc-core:${arcVersion}"
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

jar {
    archiveFileName = "${project.name}-desktop.jar"
    from sourceSets.main.output
    manifest {
        attributes('Implementation-Title': project.name, 'Implementation-Version': project.version)
    }
}

task dex(type: Jar, dependsOn: jar) {
    archiveFileName = "${project.name}.jar"
    
    doLast {
        def tempDir = temporaryDir
        // Распаковываем desktop-версию (наши классы)
        copy {
            from zipTree(jar.archiveFile)
            into tempDir
        }
        
        def sdk = System.getenv("ANDROID_HOME") ?: System.getenv("ANDROID_SDK_ROOT")
        if (sdk == null) throw new RuntimeException("ANDROID_HOME не задан")
        
        def buildToolsDir = new File(sdk, "build-tools")
        def d8File = null
        buildToolsDir.eachDir { dir ->
            def candidate = new File(dir, "d8")
            if (candidate.exists()) {
                d8File = candidate
                return true
            }
        }
        if (d8File == null) throw new RuntimeException("d8 не найден в $buildToolsDir")
        
        // Получаем все JAR-файлы зависимостей (compileClasspath)
        def classpathFiles = sourceSets.main.compileClasspath.files
        
        // Формируем аргументы для d8
        def d8Args = [d8File.absolutePath]
        classpathFiles.each { file ->
            d8Args += ["--lib", file.absolutePath]
        }
        d8Args += ["--output", tempDir.absolutePath, tempDir.absolutePath]
        
        // Запускаем d8
        exec {
            commandLine d8Args
        }
        
        // Упаковываем полученный classes.dex в финальный JAR
        ant.jar(destfile: archiveFile.get().asFile, basedir: tempDir, includes: "classes.dex")
    }
}

assemble.dependsOn dex
