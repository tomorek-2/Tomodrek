plugins {
    id 'java'
}

group = 'com.tomodrek'          // можно любое
version = '1.0.0'

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

ext {
    mindustryVersion = 'v155'
    arcVersion = 'v155'
}

repositories {
    mavenCentral()
    maven { url 'https://jitpack.io' }  // правильная ссылка
}

dependencies {
    compileOnly "com.github.Anuken.Mindustry:core:${mindustryVersion}"
    compileOnly "com.github.Anuken.Arc:arc-core:${arcVersion}"
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

// Десктоп-версия (только .class)
jar {
    archiveFileName = "${project.name}-desktop.jar"
    from sourceSets.main.output
}

// Android-версия (с classes.dex)
task dex(type: Jar, dependsOn: jar) {
    archiveFileName = "${project.name}.jar"  // универсальный JAR

    doLast {
        def tempDir = temporaryDir
        copy {
            from zipTree(jar.archiveFile)
            into tempDir
        }

        // Путь к Android SDK (задаётся в GitHub Actions)
        def sdk = System.getenv("ANDROID_HOME") ?: System.getenv("ANDROID_SDK_ROOT")
        if (sdk == null) throw new RuntimeException("ANDROID_HOME не задан")

        def d8 = fileTree(dir: "$sdk/build-tools", include: "*/d8").maxDepth(1).find()
        if (d8 == null) throw new RuntimeException("d8 не найден")

        exec {
            commandLine d8, "--lib", configurations.compileOnly.asPath,
                    "--output", tempDir, tempDir
        }

        ant.jar(destfile: archiveFile.get().asFile, basedir: tempDir, includes: "classes.dex")
    }
}

// Основная задача для GitHub Actions
assemble.dependsOn dex
